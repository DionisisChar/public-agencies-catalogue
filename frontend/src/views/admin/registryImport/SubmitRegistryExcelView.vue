<template>
  <div class="submit-registry-container">
    <h1 class="page-title">
      Î¥Ï€Î¿Î²Î¿Î»Î® Î•Ï€Î¹ÎºÎ±Î¹ÏÎ¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿Ï… ÎœÎ·Ï„ÏÏÎ¿Ï… Î¥Ï€Î·ÏÎµÏƒÎ¹ÏÎ½ ÎºÎ±Î¹ Î¦Î¿ÏÎ­Ï‰Î½ Ï„Î·Ï‚ Î•Î»Î»Î·Î½Î¹ÎºÎ®Ï‚
      Î”Î¹Î¿Î¯ÎºÎ·ÏƒÎ·Ï‚
    </h1>

    <section class="info-box">
      <h2>
        <AlertCircle style="width: 1.1em; vertical-align: middle" /> Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ­Ï‚
        Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚
      </h2>
      <br />
      <p>
        Î•Î´Ï Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Î½ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ ÎµÏ€Î¹ÎºÎ±Î¹ÏÎ¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Excel ÏŒÏ€Ï‰Ï‚ Î±Ï…Ï„ÏŒ
        Î±Î½Î±ÏÏ„Î¬Ï„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿ Î¥Ï€Î¿Ï…ÏÎ³ÎµÎ¯Î¿ Î•ÏƒÏ‰Ï„ÎµÏÎ¹ÎºÏÎ½ ÏƒÏ„Î·Î½ Î¹ÏƒÏ„Î¿ÏƒÎµÎ»Î¯Î´Î± Ï„Î¿Ï…
        <a href="https://www.ypes.gr/services/mitroo" target="_blank"
          >ÎœÎ·Ï„ÏÏÎ¿Ï… Î”Î·Î¼ÏŒÏƒÎ¹Ï‰Î½ Î¥Ï€Î·ÏÎµÏƒÎ¹ÏÎ½</a
        >.
      </p>
      <p>
        ÎœÎµ Ï„Î·Î½ Ï…Ï€Î¿Î²Î¿Î»Î® Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï…, Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± Î¸Î± ÎµÏ€Î¹Ï‡ÎµÎ¹ÏÎ®ÏƒÎµÎ¹ Î½Î± ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹
        ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î½Î­ÎµÏ‚ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ Ï€Î¿Ï… Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½Î¿Î½Ï„Î±Î¹ ÏƒÎµ Î±Ï…Ï„ÏŒ. Î”ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÏ„Î±Î¹
        Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î· ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï…Ï€Î±ÏÏ‡ÏŒÎ½Ï„Ï‰Î½ Î¿ÏÎ³Î±Î½Î¹ÏƒÎ¼ÏÎ½.
      </p>
      <p class="warning">
        <AlertTriangle style="width: 1.1em; vertical-align: middle" />
        Î£Ï…Î½Î¹ÏƒÏ„Î¬Ï„Î±Î¹ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÎ¿Î·Î³Î·Î¸ÎµÎ¯ Ï€Î»Î®ÏÎ·Ï‚ Î´Î¹Î±Î³ÏÎ±Ï†Î® Ï€Î±Î»Î±Î¹ÏŒÏ„ÎµÏÏ‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½,
        Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ¬ ÎµÎ½Î´Î­Ï‡ÎµÏ„Î±Î¹ Î½Î± Ï€ÏÎ¿ÎºÏÏˆÎ¿Ï…Î½ Î±ÏƒÏ…Î½Î­Ï€ÎµÎ¹ÎµÏ‚.
      </p>
    </section>

    <!-- Î‘Î½Î±Î¼Î¿Î½Î® Î´Î¹ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½ -->
    <div v-if="isUploading" class="upload-spinner">
      <span class="spinner-icon">â³</span>
      <span class="spinner-text"
        >Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î±ÏÏ‡ÎµÎ¯Î¿Ï…... Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ</span
      >
    </div>

    <!-- ğŸŸ¦ Upload Box -->
    <section class="upload-box">
      <h2 class="upload-title">Î¥Ï€Î¿Î²Î¿Î»Î® Î‘ÏÏ‡ÎµÎ¯Î¿Ï… Excel</h2>
      <div class="upload-area" @drop.prevent="handleDrop" @dragover.prevent>
        <input
          id="file-upload"
          type="file"
          @change="handleFileUpload"
          accept=".xls,.xlsx"
          style="display: none"
        />

        <label for="file-upload" class="upload-dropzone">
          <div class="upload-label">
            <UploadCloud
              style="width: 1.4em; margin-right: 0.5em; vertical-align: middle"
            />
            Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î® ÏƒÏÏÎµÏ„Îµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Excel ÎµÎ´Ï
          </div>
        </label>

        <div v-if="selectedFile" class="file-info">
          <div class="file-label-and-details">
            <div class="file-label">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ Î±ÏÏ‡ÎµÎ¯Î¿:</div>
            <div class="file-details">
              <span class="file-name" :title="selectedFile.name">
                {{ truncateFileName(selectedFile.name) }}
              </span>
              <span class="file-size"
                >({{ formatFileSize(selectedFile.size) }})</span
              >
            </div>
          </div>
          <div class="file-actions">
            <button @click="previewFile" title="Î ÏÎ¿Î²Î¿Î»Î®" class="icon-button">
              <Eye style="width: 1.1em" />
            </button>
            <button @click="downloadFile" title="Î›Î®ÏˆÎ·" class="icon-button">
              <Download style="width: 1.1em" />
            </button>
            <button @click="removeFile" title="Î‘Ï†Î±Î¯ÏÎµÏƒÎ·" class="icon-button">
              <FileX style="width: 1.1em" />
            </button>
          </div>
        </div>
      </div>

      <div class="upload-warning">
        <h3>
          <AlertTriangle style="width: 1.1em; vertical-align: middle" /> ÎŸÎ´Î·Î³Î¯ÎµÏ‚
          ÎºÎ±Î¹ Î£Ï…ÏƒÏ„Î¬ÏƒÎµÎ¹Ï‚
        </h3>
        <p>
          Î— Ï€Î±ÏÎ¿ÏÏƒÎ± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Ï€ÏÎ¿Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î³Î¹Î± Î¿ÏÎ¹ÏƒÏ„Î¹ÎºÎ® Ï…Ï€Î¿Î²Î¿Î»Î® Ï„Î¿Ï…
          ÎµÏ€Î¹ÎºÎ±Î¹ÏÎ¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï…, Ï„Î¿ Î¿Ï€Î¿Î¯Î¿ Î¸Î± ÎµÎ¼Ï€Î»Î¿Ï…Ï„Î¯ÏƒÎµÎ¹ Ï„Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
          Ï„Î¿Ï… ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ Î¼Îµ Î½Î­ÎµÏ‚ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚.
        </p>
        <p>
          Î”ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î· ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï…Ï€Î±ÏÏ‡ÏŒÎ½Ï„Ï‰Î½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½. Î•Î¬Î½ Î· Î²Î¬ÏƒÎ·
          Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Î®Î´Î· ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ Î¼Îµ Î¯Î´Î¹Î± Î¿Î½ÏŒÎ¼Î±Ï„Î± Î¿ÏÎ³Î±Î½Î¹ÏƒÎ¼ÏÎ½, Î¿Î¹ Î½Î­ÎµÏ‚ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ Î¸Î±
          Î±Ï€Î¿ÏÏÎ¹Ï†Î¸Î¿ÏÎ½ Î»ÏŒÎ³Ï‰ Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼ÏÎ½ Î¼Î¿Î½Î±Î´Î¹ÎºÏŒÏ„Î·Ï„Î±Ï‚ (Unique Constraint).
        </p>
        <p>
          Î•Î¬Î½ ÎµÏ€Î¹Î¸Ï…Î¼ÎµÎ¯Ï„Îµ Ï€Î»Î®ÏÎ· ÎµÏ€Î¹ÎºÎ±Î¹ÏÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î·Ï‚ Î²Î¬ÏƒÎ·Ï‚, ÏƒÏ…Î½Î¹ÏƒÏ„Î¬Ï„Î±Î¹ Î¹ÏƒÏ‡Ï…ÏÎ¬ Î½Î±
          Î­Ï‡ÎµÎ¹ Ï€ÏÎ¿Î·Î³Î·Î¸ÎµÎ¯ ÎµÎ¯Ï„Îµ:
        </p>
        <ul>
          <li>Î´Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï…Ï†Î¹ÏƒÏ„Î¬Î¼ÎµÎ½Ï‰Î½ ÎµÎ³Î³ÏÎ±Ï†ÏÎ½ Î®</li>
          <li>ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î® Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï… ÏƒÎµ ÎºÎ±Î¸Î±ÏÎ® Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.</li>
        </ul>
        <p>
          â„¹ï¸ Î— Î¼Î· Ï„Î®ÏÎ·ÏƒÎ· Ï„Ï‰Î½ Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰ ÎµÎ½Î´Î­Ï‡ÎµÏ„Î±Î¹ Î½Î± Î¿Î´Î·Î³Î®ÏƒÎµÎ¹ ÏƒÎµ Î±ÏƒÏ…Î½Î­Ï€ÎµÎ¹ÎµÏ‚ ÎºÎ±Î¹
          Ï€Î±ÏÏ‰Ï‡Î·Î¼Î­Î½Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±, ÎºÎ±Î¸ÏÏ‚ Î´ÎµÎ½ Î¸Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸Î¿ÏÎ½ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Ï„Ï‰Î½
          Ï…Ï€Î±ÏÏ‡Î¿Ï…ÏƒÏÎ½ Ï…Ï€Î·ÏÎµÏƒÎ¹ÏÎ½.
        </p>
      </div>

      <div class="final-submit">
        <button @click="confirmSubmission" :disabled="!selectedFile">
          <FileCheck
            style="width: 1.1em; vertical-align: middle; margin-right: 0.4em"
          />
          ÎŸÏÎ¹ÏƒÏ„Î¹ÎºÎ® Î¥Ï€Î¿Î²Î¿Î»Î®
        </button>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref } from "vue";
import {
  FileUp,
  FileX,
  FileCheck,
  Download,
  Eye,
  AlertCircle,
  AlertTriangle,
  UploadCloud,
} from "lucide-vue-next";
import { submitRegistryExcelFile } from "../../../services/admin/registryImport/importExcelService";

const selectedFile = ref(null);
const isUploading = ref(false);

function handleFileUpload(event) {
  const file = event.target.files[0];
  if (file && file.size <= 5 * 1024 * 1024) {
    selectedFile.value = file;
  } else {
    alert("Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼ÎµÎ³Î¬Î»Î¿. ÎœÎ­Î³Î¹ÏƒÏ„Î¿ ÎµÏ€Î¹Ï„ÏÎµÏ€Ï„ÏŒ Î¼Î­Î³ÎµÎ¸Î¿Ï‚: 5MB");
  }
}

function removeFile() {
  selectedFile.value = null;
}

function downloadFile() {
  const url = URL.createObjectURL(selectedFile.value);
  const link = document.createElement("a");
  link.href = url;
  link.download = selectedFile.value.name;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function previewFile() {
  const url = URL.createObjectURL(selectedFile.value);
  window.open(url, "_blank");
}

function truncateFileName(name) {
  return name.length > 40 ? name.substring(0, 37) + "..." : name;
}

function formatFileSize(size) {
  return (size / 1024).toFixed(1) + " KB";
}

async function confirmSubmission() {
  if (!selectedFile.value) return;
  const confirmed = confirm(
    `â— Î ÏÏŒÎºÎµÎ¹Ï„Î±Î¹ Î½Î± Ï…Ï€Î¿Î²Î¬Î»ÎµÏ„Îµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ "${selectedFile.value.name}" Î³Î¹Î± ÎµÎ¼Ï€Î»Î¿Ï…Ï„Î¹ÏƒÎ¼ÏŒ Ï„Î·Ï‚ Î²Î¬ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½. Î•Î¯ÏƒÏ„Îµ Î²Î­Î²Î±Î¹Î¿Î¹;`
  );
  if (!confirmed) return;

    isUploading.value = true;

    try{
        const response = await submitRegistryExcelFile(selectedFile.value);
        alert(response.data); // Î® Ï†Ï„Î¹Î¬Ï‡Î½Î¿Ï…Î¼Îµ Î­Î½Î± custom success popup
    } catch (error) {
        alert("âŒ Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Ï…Ï€Î¿Î²Î¿Î»Î®: " + error.response?.data || error.message);
    } finally {
        isUploading.value = false;
    }
}

function handleDrop(event) {
  const files = event.dataTransfer.files;
  if (files.length > 0) {
    handleFileUpload({ target: { files } });
  }
}
</script>

<style scoped>
.upload-title {
  text-align: center;
  font-size: 1.4rem;
  margin-bottom: 1.2rem;
}
.submit-registry-container {
  padding: 2rem;
}

.page-title {
  font-size: 1.7rem;
  font-weight: bold;
  margin-bottom: 1.8rem;
}

.info-box {
  background: linear-gradient(180deg, #f7faff 0%, #eef4fb 100%);
  border-left: 6px solid #2265ba;
  border: 1px solid #c2d7f2;
  box-shadow: 0 0 8px rgba(34, 101, 186, 0.08);
  padding: 1.6rem 1.8rem;
  border-radius: 12px;
  margin-bottom: 2rem;
  font-size: 1.05rem;
  line-height: 1.6;
  color: #10294b;
}

.upload-warning {
  background: linear-gradient(180deg, #fffdf6 0%, #fff9e6 100%);
  border-left: 6px solid #ff9900;
  border: 1px solid #ffd58a;
  box-shadow: 0 0 8px rgba(255, 153, 0, 0.08);
  padding: 1.6rem 1.8rem;
  border-radius: 12px;
  margin-bottom: 2rem;
  font-size: 0.92rem;
  line-height: 1.6;
  color: #4a2e00;
  margin-top: 30px;
}

/*.info-box,
.upload-warning {
  background: linear-gradient(180deg, #fffefc 0%, #fffdf6 100%);
  border: 1px solid #ffce73;
  border-left: 6px solid #ff9900;
  box-shadow: 0 0 8px rgba(255, 204, 102, 0.1);
  padding: 1.6rem 1.8rem;
  border-radius: 12px;
  margin-bottom: 2rem;
  font-size: 1.08rem;
  line-height: 1.6;
  color: #442e00;
} */

/*.upload-warning {
    font-size: 0.9rem;
}*/

.upload-warning h3 {
  margin-top: 0;
  margin-bottom: 1rem;
  color: #bb4e00;
  font-size: 1.1rem;
}

.upload-warning ul {
  margin: 0.4rem 0 1rem 1.2rem;
  padding-left: 1.2rem;
  list-style: disc;
}

.upload-warning li {
  margin-bottom: 0.5rem;
}

.warning {
  color: #b20000;
  font-weight: 600;
  margin-top: 1rem;
}

.upload-box {
  border: 2px dashed #a8b3c2;
  padding: 1.5rem;
  border-radius: 12px;
  background-color: #fafbfc;
}

.upload-area {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.upload-dropzone {
  border: 2px dashed #002350;
  border-radius: 12px;
  padding: 2rem;
  text-align: center;
  cursor: pointer;
  color: #555;
  font-size: 1.05rem;
  margin-bottom: 1.5rem;
  transition: border-color 0.3s;
  width: 100%;
  max-width: 640px;
}

.upload-button {
  display: inline-flex;
  align-items: center;
  background-color: #2265ba;
  color: white;
  padding: 0.6rem 1.2rem;
  font-weight: 600;
  font-size: 1.05rem;
  border-radius: 8px;
  cursor: pointer;
  margin-bottom: 1rem;
  transition: background 0.2s;
}
.upload-button:hover {
  background-color: #1c4e95;
}

.file-info {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  margin-top: 1rem;
  padding: 1rem 1.2rem;
  border: 1px solid #cbd4e1;
  background-color: #f9fbff;
  border-radius: 10px;
  font-size: 1.02rem;
  width: 100%;
  max-width: 640px;
}

.file-label-and-details {
  display: flex;
  align-items: baseline;
  gap: 0.6rem;
  flex-wrap: wrap;
}

.file-label {
  font-weight: 600;
  color: #1a1a1a;
}

.file-name {
  font-weight: 500;
  color: #003366;
}

.file-size {
  color: #666;
  font-size: 0.95rem;
  margin-left: 0.3rem;
}

.file-icon {
  font-size: 1.2rem;
}

.file-actions {
  display: flex;
  align-items: center;
  gap: 0.6rem;
}

.file-actions button {
  margin-left: 0.4rem;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.2rem;
}

.final-submit {
  margin-top: 1.8rem;
  text-align: center;
}

.final-submit button {
  background-color: #002350;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.7rem 2rem;
  font-size: 1.05rem;
  cursor: pointer;
  transition: background 0.2s;
}

.final-submit button:disabled {
  background-color: #a5b1c6;
  cursor: not-allowed;
}

.final-submit button:hover {
  background-color: #2265ba;
}

.icon-button {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.25rem;
  color: #444;
  transition: color 0.2s;
}
.icon-button:hover {
  color: #2265ba;
}

.upload-dropzone {
  border: 2px dashed #aaa;
  border-radius: 12px;
  padding: 2rem;
  text-align: center;
  cursor: pointer;
  color: #555;
  font-size: 1.05rem;
  margin-bottom: 1.5rem;
  transition: border-color 0.3s;
}

.upload-dropzone:hover {
  border-color: #2265ba;
  background-color: #f9fbff;
}

/* Animation Î³Î¹Î± ÎºÎ»ÎµÏˆÏÎ´ÏÎ± */
.upload-spinner {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.8rem;
  font-size: 1.05rem;
  margin-top: 1.5rem;
  color: #2265ba;
  animation: pulse 1.5s infinite;
}

.spinner-icon {
  animation: spin 1.2s linear infinite;
  font-size: 1.4rem;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

@keyframes pulse {
  0% {
    opacity: 0.7;
  }
  50% {
    opacity: 1;
  }
  100% {
    opacity: 0.7;
  }
}
</style>
